<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../app-route/app-route.html">

<dom-module id="data-route">
  <template>
    <app-route route="{{route}}"
               pattern="{{pattern}}"
               tail="{{tail}}"
               data="{{_appData}}">
    </app-route>
  </template>
  <script>
    /**
     * `data-route` is a modular router that supports `data-matrix` pattern.
     *
     * NOTE: Currently, it only supports one pattern matcher. Thus having the following
     *       pattern won't work `pattern=/:page1/:page2` for `:page2`. 
     *
     * Example of usage with the following route path and pattern: 
     *  
     *    route.path = /drilldown;date=20170815;groupy=assetClass,status/
     *
     *    <data-route route="{{route}}"
     *                pattern="/:foo/:zoo"
     *                data="{{dataRoute}}"></data-route>
     *
     *  The output {{dataRoute}} will be the following:
     *  
     *    { 
     *      foo: {
     *       segment: "view1",
     *       arg:     {paramA: "valA", paramB: "valB"},
     *      },
     *      zoo: {
     *        segment: "view2",
     *        args:    {paramC: "valC"}
     *      }
     *    }  
     *      
     *  It automatically synchronize the url location when modifying 
     *  the {{dataRoute}} object. Eg:
     *    
     *    this.dataRoute = {
     *      foo: {
     *        args: {paramA: "XXX"}
     *      }
     *    }
     *
     * NOTE: The implementation of this element doesn't extend 
     *       `<app-route>` since we need to intercept its `data`.
     *       Thus two different bindings are needed. Else, it is
     *       not possible to intercept and treat the `data`.
     * 
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class DataRoute extends Polymer.Element {
      static get is() { return 'data-route'; }
      static get properties() {
        return {
          route: {
            type: Object,
            notify: false
          },
          _appData: {
            type: Object,
            notify: false,
          },
          data: {
            type: Object,
            notify: true
          },
          pattern: {
            type: String,
            notify: false
          },
          _previousRoutePath: {
            type: String,
            notify: false
          }
        }
      };
      
      static get observers() {
        return [
          "_updateDataOnAppDataChanged( _appData)",
          "_updateAppDataOnDataChanged( data.*)"
        ]
      }

      /* Direction DOWN, unserializes the _appData to data */ 
      _updateAppDataOnDataChanged( dataRecord) {
        var serializedAppData = this._serialzeDataMatrix( dataRecord.base)
        
        //console.log("**** DATA CHANGED FROM PARENT", dataRecord.base, serializedAppData, this._previousRoutePath)
        
        var _appData = {}
        var firstPatternPiece = this._getFirstPatternPiece()
        _appData[firstPatternPiece] = serializedAppData;
        this._appData = _appData;
      }

      /* DIRECTON UP, serializes the data to _appData */
      _updateDataOnAppDataChanged( _appData){
        if(!this.route){ 
          return;
        }

        var previousRoutePath = this._previousRoutePath;
        var routePath = this.route.path;
        if( previousRoutePath === routePath){ 
          return;
        }
        var dataMatrix = this._deserialzeDataMatrix( _appData);
        
        //console.log("**** APPDATA CHANGED FROM CHILD", _appData, dataMatrix)
        
        if(routePath.slice(-1) != "/"){
          routePath += "/";
        }
        this.setProperties({
          "_previousRoutePath": this.route.path,
          "data": dataMatrix,
          "route.path": routePath
        })
        
      }

      /** Unserializes the data matrix string given by the `appData` of the `<app-route>` */
      _deserialzeDataMatrix(appData) {
        var deserialzedDataMatrix = {};
        var arg_key, arg_val, multi_arg_val;

        Object.keys(appData).forEach( (key) => {
          this._patternName = key;
          var dataSegments = appData[key].split(";");
          deserialzedDataMatrix[key] = dataSegments.shift();
          dataSegments.forEach( (arg) => {
            [arg_key, arg_val] = arg.split("=");
            multi_arg_val = arg_val.split(",")
            if(multi_arg_val.length > 1){
              deserialzedDataMatrix[arg_key] = multi_arg_val;
            } else {
              deserialzedDataMatrix[arg_key] = arg_val;
            }
          })
        })
        return deserialzedDataMatrix;
      }

      /** Serializes the data to string matrix that can be used in the URL */
      _serialzeDataMatrix(data) {
        var _serialzedDataMatrix = data[this._patternName] || "";
        Object.keys(data).forEach( (key) => {
          if (key != this._patternName) {
            _serialzedDataMatrix += ";"+key+"="+data[key];
          }
        })
        return _serialzedDataMatrix;
      }

      _getFirstPatternPiece(){
        if(!this.pattern){
          return;
        }
        
        var patternPieces = this.pattern.split('/');
        var firstPatternPiece = patternPieces[1];
        if (firstPatternPiece[0] == ':') {
          firstPatternPiece = firstPatternPiece.slice(1);
        }
        return firstPatternPiece;
      }
    }
    window.customElements.define(DataRoute.is, DataRoute);
  </script>
</dom-module>
