<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../app-route/app-route.html">

<dom-module id="data-route">
  <template>
    <app-route route="{{route}}"
                pattern="{{pattern}}"
                tail="{{tail}}"
                data="{{_appData}}">
    </app-route>
  </template>
  <script>
    class DataRoute extends Polymer.Element {
      static get is() { return 'data-route'; }
      static get properties() {
        return {
          route: {
            type: Object,
            notify: false
          },
          _appData: {
            type: Object,
            notify: false,
          },
          data: {
            type: Object,
            notify: true
          },
          pattern: {
            type: String,
            notify: false
          },
          _previousRoutePath: {
            type: String,
            notify: false
          }
        }
      };
      
      static get observers() {
        return [
          "_updateDataOnAppDataChanged( _appData)",
          "_updateAppDataOnDataChanged( data.*)"
        ]
      }

      /* Direction DOWN, unserializes the _appData to data */ 
      _updateAppDataOnDataChanged( dataRecord) {
        var serializedAppData = this._serialzeDataMatrix( dataRecord.base)
        
        //console.log("**** DATA CHANGED FROM PARENT", dataRecord.base, serializedAppData, this._previousRoutePath)
        
        var _appData = {}
        var firstPatternPiece = this._getFirstPatternPiece()
        _appData[firstPatternPiece] = serializedAppData;
        this._appData = _appData;
      }

      /* DIRECTON UP, serializes the data to _appData */
      _updateDataOnAppDataChanged( _appData){
        if(!this.route){ 
          return;
        }

        var previousRoutePath = this._previousRoutePath;
        var routePath = this.route.path;
        if( previousRoutePath === routePath){ 
          return;
        }
        var dataMatrix = this._deserialzeDataMatrix( _appData);
        
        //console.log("**** APPDATA CHANGED FROM CHILD", _appData, dataMatrix)
        
        this.setProperties({
          "_previousRoutePath": this.route.path,
          "data": dataMatrix
        })
      }

      /** Unserializes the data matrix string given by the `appData` of the `<app-route>` */
      _deserialzeDataMatrix(appData) {
        var deserialzedDataMatrix = {};
        var arg_key, arg_val, multi_arg_val;

        Object.keys(appData).forEach( (key) => {
          this._patternName = key;
          var dataSegments = appData[key].split(";");
          deserialzedDataMatrix[key] = dataSegments.shift();
          dataSegments.forEach( (arg) => {
            [arg_key, arg_val] = arg.split("=");
            multi_arg_val = arg_val.split(",")
            deserialzedDataMatrix[arg_key] = multi_arg_val;
          })
        })
        return deserialzedDataMatrix;
      }

      /** Serializes the data to string matrix that can be used in the URL */
      _serialzeDataMatrix(data) {
        var _serialzedDataMatrix = data[this._patternName] || "";
        Object.keys(data).forEach( (key) => {
          if (key != this._patternName) {
            _serialzedDataMatrix += ";"+key+"="+data[key];
          }
        })
        return _serialzedDataMatrix;
      }

      _getFirstPatternPiece(){
        if(!this.pattern){
          return;
        }
        
        var patternPieces = this.pattern.split('/');
        var firstPatternPiece = patternPieces[1];
        if (firstPatternPiece[0] == ':') {
          firstPatternPiece = firstPatternPiece.slice(1);
        }
        return firstPatternPiece;
      }
    }
    window.customElements.define(DataRoute.is, DataRoute);
  </script>
</dom-module>
